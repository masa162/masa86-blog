# masa86ブログ 技術仕様書

**作成日**: 2025年11月2日
**バージョン**: 1.0
**関連ドキュメント**: 要件定義書 v1.0

---

## 1. 技術スタック詳細

### 1.1 採用技術

| カテゴリ | 技術 | バージョン | 選定理由 |
|---------|------|-----------|----------|
| Webフレームワーク | Hono | ^4.0.0 | 超高速(402k ops/sec)、軽量、Cloudflare公式採用 |
| ORM | Drizzle ORM | ^0.30.0 | D1完全サポート、型安全、軽量 |
| データベース | Cloudflare D1 | - | サーバーレスSQLite、無料枠充実 |
| ランタイム | Cloudflare Workers | - | エッジコンピューティング、グローバル展開 |
| 言語 | TypeScript | ^5.0.0 | 型安全性、開発効率 |
| パッケージマネージャ | pnpm | latest | 高速、ディスク効率的 |
| デプロイツール | Wrangler | ^4.0.0 | Cloudflare公式CLI |

### 1.2 不採用技術と理由

- **Next.js**: 複雑すぎる、OpenNextとの互換性問題
- **@cloudflare/next-on-pages**: 公式非推奨
- **Remix**: 2024年に新規プロジェクト非推奨発表
- **Astro/SvelteKit**: サーバーサイドレンダリングが必要ないため過剰
- **Prisma**: D1サポートが不完全

---

## 2. プロジェクト構成

### 2.1 ディレクトリ構造

```
masa86-blog/
├── src/
│   ├── index.ts              # エントリーポイント、Honoアプリ初期化
│   ├── routes/
│   │   ├── api.ts            # API routes (/api/*)
│   │   ├── admin.ts          # 管理画面 routes (/admin/*)
│   │   └── public.ts         # 公開ページ routes (/, /posts/:slug)
│   ├── middleware/
│   │   ├── auth.ts           # Basic認証ミドルウェア
│   │   └── cors.ts           # CORS設定
│   ├── db/
│   │   ├── schema.ts         # Drizzle schema定義
│   │   ├── client.ts         # D1クライアント初期化
│   │   └── migrations/       # SQLマイグレーションファイル
│   │       └── 0001_initial.sql
│   ├── services/
│   │   └── posts.ts          # ブログ投稿のビジネスロジック
│   ├── types/
│   │   └── index.ts          # 共通型定義
│   └── views/
│       ├── layout.ts         # HTMLレイアウトテンプレート
│       ├── home.ts           # ホーム画面HTML
│       ├── post.ts           # 記事詳細HTML
│       └── admin.ts          # 管理画面HTML
├── docs/
│   ├── 要件定義書.md
│   └── 技術仕様書.md
├── wrangler.toml             # Cloudflare Workers設定
├── drizzle.config.ts         # Drizzle設定
├── tsconfig.json             # TypeScript設定
├── package.json
└── README.md
```

### 2.2 ファイル責務

| ファイル | 責務 | 依存関係 |
|---------|------|----------|
| `src/index.ts` | アプリエントリーポイント、ルート統合 | routes/*, middleware/* |
| `src/routes/api.ts` | REST API実装 | services/posts, db/client |
| `src/routes/admin.ts` | 管理画面UI | middleware/auth, views/admin |
| `src/routes/public.ts` | 公開ページUI | services/posts, views/* |
| `src/middleware/auth.ts` | Basic認証 | なし |
| `src/db/schema.ts` | データベーススキーマ | drizzle-orm |
| `src/services/posts.ts` | CRUD操作 | db/schema, db/client |

---

## 3. データベース設計

### 3.1 Drizzle Schema定義

**ファイル**: `src/db/schema.ts`

```typescript
import { sqliteTable, text, integer } from 'drizzle-orm/sqlite-core';
import { sql } from 'drizzle-orm';

export const posts = sqliteTable('posts', {
  id: integer('id').primaryKey({ autoIncrement: true }),
  slug: text('slug').notNull().unique(),
  title: text('title').notNull(),
  content: text('content').notNull(),
  tags: text('tags').notNull().default('[]'), // JSON string
  createdAt: text('created_at').notNull().default(sql`(datetime('now'))`),
  updatedAt: text('updated_at').notNull().default(sql`(datetime('now'))`)
});

export type Post = typeof posts.$inferSelect;
export type NewPost = typeof posts.$inferInsert;
```

### 3.2 既存データベースの再利用

**既存D1データベース情報**:
- **データベース名**: `masa86-blog-db`
- **Database ID**: `b04a838e-0f4f-4b87-8691-c13d02e049a8`
- **既存データ**: 3件の投稿 (slug: 0001, 0002, 0003)

**wrangler.toml設定**:

```toml
name = "masa86-blog"
main = "src/index.ts"
compatibility_date = "2025-04-01"

[[d1_databases]]
binding = "DB"
database_name = "masa86-blog-db"
database_id = "b04a838e-0f4f-4b87-8691-c13d02e049a8"
```

### 3.3 マイグレーション戦略

既存のD1データベースには既にスキーマが適用済みのため、マイグレーションは不要。
今後のスキーマ変更時は以下の手順:

```bash
# ローカル開発DB用
wrangler d1 execute masa86-blog-db --local --file=./src/db/migrations/xxxx_change.sql

# 本番DB用
wrangler d1 execute masa86-blog-db --remote --file=./src/db/migrations/xxxx_change.sql
```

---

## 4. API設計

### 4.1 エンドポイント一覧

| メソッド | パス | 認証 | 説明 |
|---------|------|------|------|
| GET | `/api/posts` | 不要 | 記事一覧取得 |
| GET | `/api/posts/:slug` | 不要 | 記事詳細取得 |
| POST | `/api/posts` | 必要 | 記事作成 |
| PUT | `/api/posts/:slug` | 必要 | 記事更新 |
| DELETE | `/api/posts/:slug` | 必要 | 記事削除 |
| GET | `/api/tags` | 不要 | タグ一覧取得 |

### 4.2 API実装例

**ファイル**: `src/routes/api.ts`

```typescript
import { Hono } from 'hono';
import { basicAuth } from '../middleware/auth';
import * as postService from '../services/posts';
import type { Env } from '../types';

const api = new Hono<{ Bindings: Env }>();

// 記事一覧取得
api.get('/posts', async (c) => {
  const posts = await postService.getAllPosts(c.env.DB);
  return c.json({ posts });
});

// 記事詳細取得
api.get('/posts/:slug', async (c) => {
  const slug = c.req.param('slug');
  const post = await postService.getPostBySlug(c.env.DB, slug);

  if (!post) {
    return c.json({ error: 'Post not found' }, 404);
  }

  return c.json({ post });
});

// 記事作成（認証必須）
api.post('/posts', basicAuth, async (c) => {
  const body = await c.req.json();
  const newPost = await postService.createPost(c.env.DB, body);
  return c.json({ post: newPost }, 201);
});

// 記事更新（認証必須）
api.put('/posts/:slug', basicAuth, async (c) => {
  const slug = c.req.param('slug');
  const body = await c.req.json();
  const updated = await postService.updatePost(c.env.DB, slug, body);

  if (!updated) {
    return c.json({ error: 'Post not found' }, 404);
  }

  return c.json({ post: updated });
});

// 記事削除（認証必須）
api.delete('/posts/:slug', basicAuth, async (c) => {
  const slug = c.req.param('slug');
  const deleted = await postService.deletePost(c.env.DB, slug);

  if (!deleted) {
    return c.json({ error: 'Post not found' }, 404);
  }

  return c.json({ message: 'Post deleted successfully' });
});

export default api;
```

### 4.3 レスポンス形式

#### 成功レスポンス

```json
{
  "post": {
    "id": 1,
    "slug": "0001",
    "title": "記事タイトル",
    "content": "# 記事内容\n\nMarkdown形式",
    "tags": ["技術", "Cloudflare"],
    "createdAt": "2025-11-02T10:00:00Z",
    "updatedAt": "2025-11-02T10:00:00Z"
  }
}
```

#### エラーレスポンス

```json
{
  "error": "Post not found"
}
```

---

## 5. サービス層設計

**ファイル**: `src/services/posts.ts`

```typescript
import { drizzle } from 'drizzle-orm/d1';
import { eq, desc } from 'drizzle-orm';
import { posts, type Post, type NewPost } from '../db/schema';

export async function getAllPosts(db: D1Database): Promise<Post[]> {
  const drizzleDb = drizzle(db);
  return await drizzleDb
    .select()
    .from(posts)
    .orderBy(desc(posts.createdAt));
}

export async function getPostBySlug(db: D1Database, slug: string): Promise<Post | undefined> {
  const drizzleDb = drizzle(db);
  const result = await drizzleDb
    .select()
    .from(posts)
    .where(eq(posts.slug, slug))
    .limit(1);

  return result[0];
}

export async function createPost(db: D1Database, data: NewPost): Promise<Post> {
  const drizzleDb = drizzle(db);

  // タグをJSON文字列に変換
  const tagsJson = Array.isArray(data.tags)
    ? JSON.stringify(data.tags)
    : data.tags;

  const result = await drizzleDb
    .insert(posts)
    .values({ ...data, tags: tagsJson })
    .returning();

  return result[0];
}

export async function updatePost(
  db: D1Database,
  slug: string,
  data: Partial<NewPost>
): Promise<Post | undefined> {
  const drizzleDb = drizzle(db);

  // タグをJSON文字列に変換
  if (data.tags && Array.isArray(data.tags)) {
    data.tags = JSON.stringify(data.tags) as any;
  }

  const result = await drizzleDb
    .update(posts)
    .set({ ...data, updatedAt: new Date().toISOString() })
    .where(eq(posts.slug, slug))
    .returning();

  return result[0];
}

export async function deletePost(db: D1Database, slug: string): Promise<boolean> {
  const drizzleDb = drizzle(db);

  const result = await drizzleDb
    .delete(posts)
    .where(eq(posts.slug, slug))
    .returning();

  return result.length > 0;
}

export async function getAllTags(db: D1Database): Promise<string[]> {
  const drizzleDb = drizzle(db);
  const allPosts = await drizzleDb.select({ tags: posts.tags }).from(posts);

  const tagsSet = new Set<string>();
  allPosts.forEach(post => {
    const tags = JSON.parse(post.tags);
    tags.forEach((tag: string) => tagsSet.add(tag));
  });

  return Array.from(tagsSet).sort();
}
```

---

## 6. 認証ミドルウェア

**ファイル**: `src/middleware/auth.ts`

```typescript
import { Context, Next } from 'hono';
import type { Env } from '../types';

export async function basicAuth(c: Context<{ Bindings: Env }>, next: Next) {
  const authHeader = c.req.header('Authorization');

  if (!authHeader || !authHeader.startsWith('Basic ')) {
    return c.json({ error: 'Unauthorized' }, 401, {
      'WWW-Authenticate': 'Basic realm="Admin Area"'
    });
  }

  const base64Credentials = authHeader.substring(6);
  const credentials = atob(base64Credentials);
  const [username, password] = credentials.split(':');

  // 環境変数から認証情報を取得
  const validUsername = c.env.ADMIN_USERNAME;
  const validPassword = c.env.ADMIN_PASSWORD;

  if (username !== validUsername || password !== validPassword) {
    return c.json({ error: 'Invalid credentials' }, 401, {
      'WWW-Authenticate': 'Basic realm="Admin Area"'
    });
  }

  await next();
}
```

### 6.1 環境変数設定

**wrangler.toml** (本番環境):

```toml
[vars]
ADMIN_USERNAME = "admin"

# パスワードはシークレットとして設定（wrangler.tomlには記載しない）
# 以下のコマンドで設定:
# wrangler secret put ADMIN_PASSWORD
```

**ローカル開発用** (`.dev.vars`):

```
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your_secure_password_here
```

---

## 7. フロントエンド設計

### 7.1 HTMLテンプレート戦略

Honoの `html` ヘルパーを使用したシンプルなサーバーサイドレンダリング。

**ファイル**: `src/views/layout.ts`

```typescript
import { html } from 'hono/html';

export const layout = (title: string, content: string) => html`
<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>${title} | masa86 Blog</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      line-height: 1.6;
      color: #333;
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem 1rem;
      background: #f5f5f5;
    }
    header {
      margin-bottom: 2rem;
      padding-bottom: 1rem;
      border-bottom: 2px solid #333;
    }
    h1 { font-size: 2rem; margin-bottom: 0.5rem; }
    nav a { margin-right: 1rem; text-decoration: none; color: #0066cc; }
    nav a:hover { text-decoration: underline; }
    article {
      background: white;
      padding: 2rem;
      border-radius: 8px;
      margin-bottom: 2rem;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    .post-meta {
      color: #666;
      font-size: 0.9rem;
      margin-bottom: 1rem;
    }
    .tag {
      display: inline-block;
      background: #e0e0e0;
      padding: 0.2rem 0.6rem;
      border-radius: 4px;
      font-size: 0.85rem;
      margin-right: 0.5rem;
    }
  </style>
</head>
<body>
  <header>
    <h1>masa86 Blog</h1>
    <nav>
      <a href="/">ホーム</a>
      <a href="/admin">管理画面</a>
    </nav>
  </header>
  <main>
    ${content}
  </main>
</body>
</html>
`;
```

### 7.2 ホーム画面

**ファイル**: `src/views/home.ts`

```typescript
import { html } from 'hono/html';
import type { Post } from '../db/schema';

export const homePage = (posts: Post[]) => {
  const postsHtml = posts.map(post => {
    const tags = JSON.parse(post.tags);
    const tagsHtml = tags.map((tag: string) =>
      html`<span class="tag">${tag}</span>`
    ).join('');

    return html`
      <article>
        <h2><a href="/posts/${post.slug}">${post.title}</a></h2>
        <div class="post-meta">
          ${new Date(post.createdAt).toLocaleDateString('ja-JP')}
        </div>
        <div>${tagsHtml}</div>
      </article>
    `;
  }).join('');

  return html`
    <h2>最新記事</h2>
    ${postsHtml}
  `;
};
```

### 7.3 記事詳細画面

**ファイル**: `src/views/post.ts`

```typescript
import { html } from 'hono/html';
import type { Post } from '../db/schema';

export const postPage = (post: Post) => {
  const tags = JSON.parse(post.tags);
  const tagsHtml = tags.map((tag: string) =>
    html`<span class="tag">${tag}</span>`
  ).join('');

  return html`
    <article>
      <h2>${post.title}</h2>
      <div class="post-meta">
        ${new Date(post.createdAt).toLocaleDateString('ja-JP')}
      </div>
      <div style="margin-bottom: 1rem">${tagsHtml}</div>
      <div class="content">
        ${post.content}
      </div>
    </article>
    <a href="/">← 一覧に戻る</a>
  `;
};
```

### 7.4 管理画面

**ファイル**: `src/views/admin.ts`

```typescript
import { html } from 'hono/html';
import type { Post } from '../db/schema';

export const adminPage = (posts: Post[]) => {
  const postsTable = posts.map(post => html`
    <tr>
      <td>${post.slug}</td>
      <td>${post.title}</td>
      <td>${new Date(post.createdAt).toLocaleDateString('ja-JP')}</td>
      <td>
        <button onclick="editPost('${post.slug}')">編集</button>
        <button onclick="deletePost('${post.slug}')">削除</button>
      </td>
    </tr>
  `).join('');

  return html`
    <h2>記事管理</h2>
    <button onclick="showCreateForm()">新規作成</button>

    <table style="width: 100%; margin-top: 1rem; border-collapse: collapse;">
      <thead>
        <tr style="background: #f0f0f0;">
          <th style="padding: 0.5rem; text-align: left;">Slug</th>
          <th style="padding: 0.5rem; text-align: left;">タイトル</th>
          <th style="padding: 0.5rem; text-align: left;">作成日</th>
          <th style="padding: 0.5rem; text-align: left;">操作</th>
        </tr>
      </thead>
      <tbody>
        ${postsTable}
      </tbody>
    </table>

    <script>
      async function deletePost(slug) {
        if (!confirm('本当に削除しますか？')) return;

        const response = await fetch(\`/api/posts/\${slug}\`, {
          method: 'DELETE',
          headers: {
            'Authorization': 'Basic ' + btoa('admin:' + prompt('パスワードを入力'))
          }
        });

        if (response.ok) {
          location.reload();
        } else {
          alert('削除に失敗しました');
        }
      }

      function editPost(slug) {
        window.location.href = \`/admin/edit/\${slug}\`;
      }

      function showCreateForm() {
        window.location.href = '/admin/new';
      }
    </script>
  `;
};
```

---

## 8. ルーティング設計

**ファイル**: `src/index.ts`

```typescript
import { Hono } from 'hono';
import { cors } from 'hono/cors';
import api from './routes/api';
import admin from './routes/admin';
import publicRoutes from './routes/public';
import type { Env } from './types';

const app = new Hono<{ Bindings: Env }>();

// CORSミドルウェア
app.use('/*', cors());

// ルート統合
app.route('/api', api);
app.route('/admin', admin);
app.route('/', publicRoutes);

export default app;
```

**ファイル**: `src/routes/public.ts`

```typescript
import { Hono } from 'hono';
import * as postService from '../services/posts';
import { layout } from '../views/layout';
import { homePage } from '../views/home';
import { postPage } from '../views/post';
import type { Env } from '../types';

const publicRoutes = new Hono<{ Bindings: Env }>();

// ホーム画面
publicRoutes.get('/', async (c) => {
  const posts = await postService.getAllPosts(c.env.DB);
  const content = homePage(posts);
  return c.html(layout('ホーム', content));
});

// 記事詳細
publicRoutes.get('/posts/:slug', async (c) => {
  const slug = c.req.param('slug');
  const post = await postService.getPostBySlug(c.env.DB, slug);

  if (!post) {
    return c.html(layout('Not Found', '<h2>記事が見つかりません</h2>'), 404);
  }

  const content = postPage(post);
  return c.html(layout(post.title, content));
});

export default publicRoutes;
```

---

## 9. 型定義

**ファイル**: `src/types/index.ts`

```typescript
export interface Env {
  DB: D1Database;
  ADMIN_USERNAME: string;
  ADMIN_PASSWORD: string;
}

export interface PostCreateRequest {
  slug: string;
  title: string;
  content: string;
  tags: string[];
}

export interface PostUpdateRequest {
  title?: string;
  content?: string;
  tags?: string[];
}
```

---

## 10. 開発環境セットアップ

### 10.1 初期セットアップ手順

```bash
# 1. 依存関係インストール
pnpm install

# 2. ローカル環境変数設定
cat > .dev.vars << 'EOF'
ADMIN_USERNAME=admin
ADMIN_PASSWORD=your_secure_password
EOF

# 3. ローカル開発サーバー起動
pnpm dev

# 4. D1ダッシュボード確認（別ターミナル）
wrangler d1 execute masa86-blog-db --local --command "SELECT * FROM posts"
```

### 10.2 package.json

```json
{
  "name": "masa86-blog",
  "version": "1.0.0",
  "type": "module",
  "scripts": {
    "dev": "wrangler dev",
    "deploy": "wrangler deploy",
    "test": "vitest",
    "db:local": "wrangler d1 execute masa86-blog-db --local --file=",
    "db:remote": "wrangler d1 execute masa86-blog-db --remote --file="
  },
  "dependencies": {
    "hono": "^4.0.0",
    "drizzle-orm": "^0.30.0"
  },
  "devDependencies": {
    "@cloudflare/workers-types": "^4.20250101.0",
    "wrangler": "^4.0.0",
    "typescript": "^5.0.0",
    "vitest": "^1.0.0"
  }
}
```

### 10.3 TypeScript設定

**tsconfig.json**:

```json
{
  "compilerOptions": {
    "target": "ES2022",
    "module": "ES2022",
    "lib": ["ES2022"],
    "moduleResolution": "bundler",
    "strict": true,
    "skipLibCheck": true,
    "esModuleInterop": true,
    "resolveJsonModule": true,
    "isolatedModules": true,
    "types": ["@cloudflare/workers-types"]
  },
  "include": ["src/**/*"],
  "exclude": ["node_modules"]
}
```

### 10.4 Drizzle設定

**drizzle.config.ts**:

```typescript
import type { Config } from 'drizzle-kit';

export default {
  schema: './src/db/schema.ts',
  out: './src/db/migrations',
  driver: 'd1',
  dbCredentials: {
    wranglerConfigPath: './wrangler.toml',
    dbName: 'masa86-blog-db'
  }
} satisfies Config;
```

---

## 11. デプロイ手順

### 11.1 初回デプロイ

```bash
# 1. シークレット設定（本番パスワード）
wrangler secret put ADMIN_PASSWORD
# プロンプトで安全なパスワードを入力

# 2. デプロイ実行
pnpm deploy

# 3. デプロイ確認
wrangler deployments list

# 4. 動作確認
curl https://masa86-blog.workers.dev/api/posts
```

### 11.2 更新デプロイ

```bash
# コード変更後
git add .
git commit -m "Update: 機能追加"
pnpm deploy
```

### 11.3 ロールバック

```bash
# 前のバージョンに戻す
wrangler rollback
```

---

## 12. パフォーマンス最適化

### 12.1 目標値

| 指標 | 目標 | 測定方法 |
|------|------|----------|
| API応答時間 | < 100ms | wrangler tail でログ確認 |
| ページ表示時間 | < 200ms | ブラウザDevTools |
| データベースクエリ | < 50ms | Drizzleログ |
| Workers起動時間 | < 10ms | Cloudflareダッシュボード |

### 12.2 最適化戦略

1. **クエリ最適化**
   - インデックス活用（slug, created_at）
   - SELECT句で必要なカラムのみ取得
   - LIMIT句で結果セット制限

2. **キャッシュ戦略**
   ```typescript
   // Cache APIを使用した記事キャッシュ
   api.get('/posts/:slug', async (c) => {
     const cache = caches.default;
     const cacheKey = new Request(c.req.url);

     let response = await cache.match(cacheKey);
     if (response) return response;

     // データベースから取得
     const post = await postService.getPostBySlug(c.env.DB, slug);
     response = c.json({ post });

     // 5分間キャッシュ
     c.header('Cache-Control', 'public, max-age=300');
     await cache.put(cacheKey, response.clone());

     return response;
   });
   ```

3. **バンドルサイズ削減**
   - Honoは軽量（~12KB）
   - Drizzle ORMは必要最小限
   - 外部ライブラリ最小化

---

## 13. セキュリティ対策

### 13.1 実装済み対策

| 脅威 | 対策 | 実装箇所 |
|------|------|----------|
| 認証突破 | Basic認証 + HTTPS強制 | middleware/auth.ts |
| SQLインジェクション | Drizzle ORM（パラメータ化） | services/posts.ts |
| XSS | Honoのエスケープ機能 | views/*.ts |
| CSRF | SameSite Cookie (将来実装) | - |
| DDoS | Cloudflare自動保護 | インフラレベル |

### 13.2 追加推奨対策

```typescript
// Rate Limiting実装例
import { rateLimiter } from 'hono-rate-limiter';

api.use('/posts/*', rateLimiter({
  windowMs: 15 * 60 * 1000, // 15分
  max: 100, // 最大100リクエスト
  message: 'Too many requests'
}));
```

---

## 14. 監視とロギング

### 14.1 ログ出力

```typescript
// エラーログ
console.error('[ERROR]', {
  path: c.req.path,
  error: error.message,
  timestamp: new Date().toISOString()
});

// アクセスログ
console.log('[ACCESS]', {
  method: c.req.method,
  path: c.req.path,
  duration: `${Date.now() - start}ms`
});
```

### 14.2 リアルタイム監視

```bash
# ログストリーミング
wrangler tail

# フィルタリング
wrangler tail --format json | grep ERROR
```

### 14.3 メトリクス

Cloudflareダッシュボードで以下を監視:
- リクエスト数
- エラー率
- 応答時間（p50, p95, p99）
- CPU使用時間
- メモリ使用量

---

## 15. テスト戦略

### 15.1 単体テスト

**ファイル**: `src/services/posts.test.ts`

```typescript
import { describe, it, expect, beforeEach } from 'vitest';
import { getPlatformProxy } from 'wrangler';
import * as postService from './posts';

describe('Post Service', () => {
  let db: D1Database;

  beforeEach(async () => {
    const { env } = await getPlatformProxy();
    db = env.DB;
  });

  it('should fetch all posts', async () => {
    const posts = await postService.getAllPosts(db);
    expect(posts).toBeInstanceOf(Array);
    expect(posts.length).toBeGreaterThan(0);
  });

  it('should create a new post', async () => {
    const newPost = {
      slug: 'test-post',
      title: 'Test Post',
      content: 'Test content',
      tags: '["test"]'
    };

    const created = await postService.createPost(db, newPost);
    expect(created.slug).toBe('test-post');
    expect(created.title).toBe('Test Post');
  });
});
```

### 15.2 統合テスト

```bash
# ローカル環境でE2Eテスト
pnpm dev &
curl http://localhost:8787/api/posts
curl -X POST http://localhost:8787/api/posts \
  -H "Authorization: Basic YWRtaW46cGFzc3dvcmQ=" \
  -H "Content-Type: application/json" \
  -d '{"slug":"test","title":"Test","content":"# Test","tags":["test"]}'
```

---

## 16. トラブルシューティング

### 16.1 よくある問題

| 症状 | 原因 | 解決方法 |
|------|------|----------|
| 500 Internal Server Error | D1バインディング未設定 | wrangler.tomlを確認 |
| 401 Unauthorized | 認証情報が間違い | .dev.varsとシークレットを確認 |
| ビルドエラー | 型定義不一致 | `pnpm install`再実行 |
| デプロイ失敗 | wrangler.toml設定ミス | database_id確認 |

### 16.2 デバッグ方法

```typescript
// デバッグログ追加
api.use('*', async (c, next) => {
  console.log('[DEBUG]', {
    method: c.req.method,
    path: c.req.path,
    headers: Object.fromEntries(c.req.headers.entries())
  });
  await next();
});
```

---

## 17. 今後の拡張計画

### 17.1 Phase 2機能（優先度: 中）

- [ ] マークダウンプレビュー機能
- [ ] 画像アップロード（Cloudflare Images連携）
- [ ] 全文検索機能（D1 FTS5）
- [ ] RSS/Atomフィード
- [ ] OGP画像自動生成

### 17.2 Phase 3機能（優先度: 低）

- [ ] コメント機能（Cloudflare Durable Objects）
- [ ] アクセス解析（Workers Analytics Engine）
- [ ] 多言語対応
- [ ] Webメンション対応

---

## 18. 参考資料

### 18.1 公式ドキュメント

- [Hono Documentation](https://hono.dev/)
- [Drizzle ORM - D1](https://orm.drizzle.team/docs/get-started-sqlite#cloudflare-d1)
- [Cloudflare Workers](https://developers.cloudflare.com/workers/)
- [Cloudflare D1](https://developers.cloudflare.com/d1/)

### 18.2 参考実装

- [Hono Examples - D1](https://github.com/honojs/examples/tree/main/cloudflare-d1)
- [Cloudflare Blog Template](https://developers.cloudflare.com/workers/examples/)

---

## 変更履歴

| 日付 | バージョン | 変更内容 | 作成者 |
|------|-----------|---------|--------|
| 2025-11-02 | 1.0 | 初版作成 | Claude |

---

**次のステップ**: プロジェクト初期化とHonoセットアップ

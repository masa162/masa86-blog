# masa86ブログ 要件定義書

**作成日**: 2025年11月2日
**バージョン**: 1.0
**プロジェクト**: masa86個人技術ブログ

---

## 1. プロジェクト概要

### 1.1 目的
技術的な学びや日々の開発で得た知識を記録・共有するための個人ブログを構築する。

### 1.2 背景
- 既存のNext.js + OpenNextの構成が複雑で不安定
- シンプルで高速、堅牢なブログシステムが必要
- Cloudflareのエッジネットワークを活用した高速配信を実現

### 1.3 ゴール
- **安定性**: 500エラーのない確実な動作
- **高速性**: エッジでの高速レスポンス（<100ms）
- **シンプル**: メンテナンス容易な最小構成
- **堅牢性**: 将来性のある技術スタック

---

## 2. 技術スタック

### 2.1 フレームワーク・ライブラリ

| 用途 | 技術 | バージョン | 理由 |
|------|------|-----------|------|
| Webフレームワーク | **Hono** | latest | 最速、最軽量、Cloudflare公式使用 |
| ORM | **Drizzle** | latest | D1対応、高速、型安全 |
| データベース | **Cloudflare D1** | - | サーバーレスSQL、既存DB活用 |
| ランタイム | **Cloudflare Workers** | - | エッジコンピューティング |
| 認証 | **Basic Auth** | - | シンプル、HTTPS必須 |
| 言語 | **TypeScript** | latest | 型安全性 |

### 2.2 非採用技術とその理由

| 技術 | 理由 |
|------|------|
| Next.js | 複雑すぎる、OpenNextが不安定 |
| Remix | 新規プロジェクト非推奨に |
| Cloudflare Pages | Workers投資に集中、Pages終了予定 |
| Prisma | D1非対応 |
| R2 | 不要（テキストベースブログ） |

---

## 3. 機能要件

### 3.1 ブログ閲覧機能（公開）

#### F-001: ブログ記事一覧表示
- **優先度**: 高
- **説明**: 最新記事10件を新しい順に表示
- **エンドポイント**: `GET /`
- **表示項目**:
  - 記事タイトル
  - 作成日時（日本語形式）
  - タグ一覧
  - 記事プレビュー（200文字）
- **UI要件**:
  - シンプルなカード形式
  - レスポンシブ対応

#### F-002: 記事詳細表示
- **優先度**: 高
- **説明**: 個別記事の全文を表示
- **エンドポイント**: `GET /:slug`
- **表示項目**:
  - 記事タイトル
  - 作成日時・更新日時
  - タグ一覧
  - Markdown → HTML変換された本文
- **機能**:
  - シンタックスハイライト対応
  - レスポンシブ対応

#### F-003: タグ別記事一覧
- **優先度**: 中
- **説明**: 特定タグの記事を一覧表示
- **エンドポイント**: `GET /tags/:tag`

### 3.2 管理機能（認証必須）

#### F-101: 管理画面トップ
- **優先度**: 高
- **説明**: 記事一覧と管理メニュー
- **エンドポイント**: `GET /admin`
- **認証**: Basic認証
- **表示項目**:
  - 全記事一覧（編集・削除リンク付き）
  - 新規作成ボタン

#### F-102: 記事新規作成
- **優先度**: 高
- **説明**: 新しい記事を作成
- **エンドポイント**: `GET /admin/new`, `POST /api/posts`
- **入力項目**:
  - タイトル（必須）
  - 本文（Markdown、必須）
  - タグ（カンマ区切り）
- **バリデーション**:
  - タイトル: 1-200文字
  - 本文: 必須
- **自動生成**:
  - slug: 4桁ゼロパディング（0001, 0002...）
  - created_at: 現在時刻
  - updated_at: 現在時刻

#### F-103: 記事編集
- **優先度**: 高
- **説明**: 既存記事を編集
- **エンドポイント**: `GET /admin/edit/:id`, `PUT /api/posts/:id`
- **機能**:
  - 既存データを表示
  - 更新時にupdated_atを自動更新

#### F-104: 記事削除
- **優先度**: 高
- **説明**: 記事を削除
- **エンドポイント**: `DELETE /api/posts/:id`
- **確認**: JavaScript confirmで確認

---

## 4. 非機能要件

### 4.1 パフォーマンス

| 項目 | 目標値 | 測定方法 |
|------|--------|----------|
| レスポンスタイム | <100ms | Cloudflare Analytics |
| コールドスタート | <50ms | Workers Analytics |
| TTFBブログ一覧 | <200ms | Lighthouse |
| TTFBブログ詳細 | <150ms | Lighthouse |

### 4.2 可用性・安定性

- **稼働率**: 99.9%以上（Cloudflare SLA準拠）
- **エラーレート**: <0.1%
- **データ整合性**: D1トランザクション保証

### 4.3 セキュリティ

| 項目 | 要件 |
|------|------|
| 通信暗号化 | HTTPS必須（Cloudflare SSL） |
| 管理画面認証 | Basic認証（HTTPS経由） |
| XSS対策 | HTMLエスケープ処理 |
| CSRF対策 | 同一オリジン検証 |
| SQLインジェクション対策 | Drizzle ORM使用 |

### 4.4 保守性・拡張性

- **コード行数**: <1000行（シンプル維持）
- **依存パッケージ**: 最小限（Hono, Drizzle, wrangler）
- **ドキュメント**: 要件定義書、技術仕様書
- **バージョン管理**: Git (GitHub)

### 4.5 互換性

- **ブラウザ**: モダンブラウザ最新2バージョン
- **デバイス**: PC、タブレット、スマートフォン
- **D1**: 既存データベース・スキーマ互換

---

## 5. データモデル

### 5.1 postsテーブル（既存）

| カラム名 | 型 | 制約 | 説明 |
|---------|-------|------|------|
| id | INTEGER | PRIMARY KEY AUTOINCREMENT | 記事ID |
| slug | TEXT | NOT NULL UNIQUE | URL用スラッグ（0001, 0002...） |
| title | TEXT | NOT NULL | 記事タイトル |
| content | TEXT | NOT NULL | Markdown形式の本文 |
| tags | TEXT | NOT NULL DEFAULT '[]' | JSON配列形式のタグ |
| created_at | TEXT | NOT NULL | 作成日時（ISO8601） |
| updated_at | TEXT | NOT NULL | 更新日時（ISO8601） |

**インデックス**:
- `idx_posts_slug`: slug（UNIQUE）
- `idx_posts_created_at`: created_at DESC

**トリガー**:
- `update_posts_updated_at`: UPDATE時に自動でupdated_at更新

### 5.2 データ例

既存データ（3件）:
- 0001: テスト
- 0002: はじめまして - masa86ブログ開始
- 0003: Cloudflare Pagesでブログを構築した話

---

## 6. 画面設計

### 6.1 公開画面

#### 6.1.1 ブログトップページ (`/`)
```
┌─────────────────────────────────┐
│  masa86 Blog                    │ <- ヘッダー
├─────────────────────────────────┤
│  最新の記事                      │
│                                 │
│  ┌───────────────────────────┐  │
│  │ タイトル                   │  │
│  │ 2025年11月2日              │  │
│  │ [タグ1] [タグ2]            │  │
│  │ プレビューテキスト...      │  │
│  └───────────────────────────┘  │
│                                 │
│  ┌───────────────────────────┐  │
│  │ 次の記事...                │  │
│  └───────────────────────────┘  │
│                                 │
│  [管理画面]                     │
├─────────────────────────────────┤
│  © 2025 masa86 Blog            │ <- フッター
└─────────────────────────────────┘
```

#### 6.1.2 記事詳細ページ (`/:slug`)
```
┌─────────────────────────────────┐
│  masa86 Blog                    │
├─────────────────────────────────┤
│  記事タイトル                    │
│  2025年11月2日 (更新: 11月3日)  │
│  [タグ1] [タグ2]                │
│                                 │
│  ─────────────────────────      │
│                                 │
│  # 見出し1                      │
│  本文テキスト...                │
│                                 │
│  ## 見出し2                     │
│  コード例:                      │
│  ```                            │
│  code here                      │
│  ```                            │
│                                 │
│  [← トップに戻る]               │
├─────────────────────────────────┤
│  © 2025 masa86 Blog            │
└─────────────────────────────────┘
```

### 6.2 管理画面

#### 6.2.1 管理トップ (`/admin`)
```
┌─────────────────────────────────┐
│  管理画面 - masa86 Blog         │
├─────────────────────────────────┤
│  [新規作成]                      │
│                                 │
│  記事一覧:                       │
│  ┌───────────────────────────┐  │
│  │ 0003: Cloudflare Pages... │  │
│  │ [編集] [削除]             │  │
│  └───────────────────────────┘  │
│  ┌───────────────────────────┐  │
│  │ 0002: はじめまして...     │  │
│  │ [編集] [削除]             │  │
│  └───────────────────────────┘  │
│                                 │
│  [ブログトップへ戻る]            │
└─────────────────────────────────┘
```

#### 6.2.2 記事作成・編集 (`/admin/new`, `/admin/edit/:id`)
```
┌─────────────────────────────────┐
│  記事作成/編集                   │
├─────────────────────────────────┤
│  タイトル:                       │
│  [___________________________]  │
│                                 │
│  本文 (Markdown):               │
│  [___________________________]  │
│  [                           ]  │
│  [                           ]  │
│  [___________________________]  │
│                                 │
│  タグ (カンマ区切り):            │
│  [___________________________]  │
│                                 │
│  [保存] [キャンセル]             │
└─────────────────────────────────┘
```

---

## 7. API仕様

### 7.1 公開API

| メソッド | エンドポイント | 説明 | 認証 |
|---------|---------------|------|------|
| GET | `/` | ブログトップ（記事一覧） | 不要 |
| GET | `/:slug` | 記事詳細 | 不要 |
| GET | `/tags/:tag` | タグ別記事一覧 | 不要 |

### 7.2 管理API

| メソッド | エンドポイント | 説明 | 認証 |
|---------|---------------|------|------|
| GET | `/admin` | 管理画面トップ | Basic |
| GET | `/admin/new` | 新規作成フォーム | Basic |
| GET | `/admin/edit/:id` | 編集フォーム | Basic |
| POST | `/api/posts` | 記事作成 | Basic |
| PUT | `/api/posts/:id` | 記事更新 | Basic |
| DELETE | `/api/posts/:id` | 記事削除 | Basic |

### 7.3 API詳細

#### POST /api/posts（記事作成）

**リクエスト**:
```json
{
  "title": "記事タイトル",
  "content": "# 見出し\n本文...",
  "tags": ["技術", "Cloudflare"]
}
```

**レスポンス** (201 Created):
```json
{
  "success": true,
  "post": {
    "id": 4,
    "slug": "0004",
    "title": "記事タイトル",
    "created_at": "2025-11-02T12:00:00.000Z"
  }
}
```

#### PUT /api/posts/:id（記事更新）

**リクエスト**:
```json
{
  "title": "更新後タイトル",
  "content": "更新後本文",
  "tags": ["新タグ"]
}
```

**レスポンス** (200 OK):
```json
{
  "success": true,
  "post": {
    "id": 4,
    "updated_at": "2025-11-02T13:00:00.000Z"
  }
}
```

#### DELETE /api/posts/:id（記事削除）

**レスポンス** (200 OK):
```json
{
  "success": true,
  "message": "記事を削除しました"
}
```

---

## 8. 認証仕様

### 8.1 Basic認証

**対象エンドポイント**:
- `/admin/*` すべて
- `/api/posts` POST/PUT/DELETE

**認証情報**:
- ユーザー名: 環境変数 `BASIC_AUTH_USER`
- パスワード: 環境変数 `BASIC_AUTH_PASS`

**実装**:
```typescript
// Honoミドルウェア
app.use('/admin/*', basicAuth({
  username: env.BASIC_AUTH_USER,
  password: env.BASIC_AUTH_PASS,
}))
```

**セキュリティ要件**:
- HTTPS必須（Cloudflare自動提供）
- 認証失敗時: 401 Unauthorized
- WWW-Authenticate ヘッダー返却

---

## 9. デプロイ仕様

### 9.1 プラットフォーム

**Cloudflare Workers**
- Pagesではなく、Workersを採用（2025年推奨）
- 理由: 将来投資、機能豊富、静的資産も無料

### 9.2 環境変数

| 変数名 | 説明 | 設定場所 |
|--------|------|---------|
| `DB` | D1バインディング | wrangler.toml |
| `BASIC_AUTH_USER` | 管理画面ユーザー名 | Cloudflare Dashboard |
| `BASIC_AUTH_PASS` | 管理画面パスワード | Cloudflare Dashboard |

### 9.3 D1バインディング

**wrangler.toml**:
```toml
[[d1_databases]]
binding = "DB"
database_name = "masa86-blog-db"
database_id = "b04a838e-0f4f-4b87-8691-c13d02e049a8"
```

### 9.4 デプロイコマンド

```bash
# ビルド
npm run build

# ローカル開発
npm run dev

# 本番デプロイ
npm run deploy  # wrangler deploy
```

### 9.5 CI/CD

**GitHub Actions** (オプション):
- mainブランチへのpush時に自動デプロイ
- Wrangler Action使用

---

## 10. 開発フェーズ

### Phase 1: 基盤構築（2時間）
- [x] 要件定義書作成
- [ ] 技術仕様書作成
- [ ] Honoプロジェクト初期化
- [ ] Drizzle ORM設定
- [ ] D1接続確認

### Phase 2: コア機能実装（3時間）
- [ ] 記事一覧API
- [ ] 記事詳細API
- [ ] Markdown → HTML変換
- [ ] Basic認証ミドルウェア
- [ ] CRUD API実装

### Phase 3: UI実装（2時間）
- [ ] ブログトップページ
- [ ] 記事詳細ページ
- [ ] 管理画面（一覧・新規・編集）
- [ ] レスポンシブ対応

### Phase 4: デプロイ・テスト（1時間）
- [ ] wrangler設定
- [ ] Workers デプロイ
- [ ] 本番環境テスト
- [ ] パフォーマンス測定

**想定総作業時間**: 8時間

---

## 11. 成功基準

### 11.1 必須要件
- ✅ 500エラーが発生しない
- ✅ レスポンスタイム <200ms
- ✅ 記事の作成・編集・削除が正常動作
- ✅ Basic認証が機能
- ✅ スマホ・PCで正常表示

### 11.2 期待効果
- **パフォーマンス**: Next.js比で10倍高速化
- **安定性**: エラー率 0%
- **保守性**: コード量 1/10
- **コスト**: Workers無料枠内（月100万リクエスト）

---

## 12. リスクと対策

| リスク | 影響度 | 対策 |
|--------|--------|------|
| D1接続エラー | 高 | 既存DBで動作確認済み |
| 認証突破 | 中 | HTTPS + 強力なパスワード |
| Workers制限超過 | 低 | 個人ブログで想定外 |
| Hono学習コスト | 低 | 公式ドキュメント豊富 |

---

## 13. 参考資料

- [Hono公式ドキュメント](https://hono.dev/)
- [Drizzle ORM D1ガイド](https://orm.drizzle.team/docs/get-started-sqlite#cloudflare-d1)
- [Cloudflare Workers公式](https://developers.cloudflare.com/workers/)
- [D1 Database公式](https://developers.cloudflare.com/d1/)

---

**承認者**: _____________
**承認日**: _____________
